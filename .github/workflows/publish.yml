name: Build and Publish Quran Android App

on:
  push:
    branches: [ main ] # Trigger on pushes to the main branch

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- Step 1: Decode Keystore from Secrets ---
      # This step creates the physical 'release.jks' file that gradle.properties points to.
      - name: Decode Keystore file
        run: |
          echo ${{ secrets.RELEASE_KEYSTORE }} | base64 --decode > release.jks
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build and Sign AAB
        # This command uses the properties from gradle.properties and finds the release.jks file.
        # It should no longer fail with "Keystore file not found".
        # We specify the 'madani' flavor task.
        run: ./gradlew bundleMadaniRelease

      # --- Step 2: Upload to Google Play Store ---
      - name: Upload Artifact to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          # Use the secret name you configured for your JSON key file
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          # Use the correct application ID from your build.gradle
          packageName: com.quran.labs.androidquran 
          # Specify the path for the specific flavor's AAB file
          releaseFiles: app/build/outputs/bundle/madaniRelease/app-madani-release.aab
          track: internal # Options: internal, alpha, beta, production
          status: completed

